<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
      <title>Handle domain reloads | mysite </title>
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <meta name="title" content="Handle domain reloads | mysite ">
      
      
      <link rel="icon" href="../../../../favicon.ico">
      <link rel="stylesheet" href="../../../../public/docfx.min.css">
      <link rel="stylesheet" href="../../../../public/main.css">
      <meta name="docfx:navrel" content="../../../../toc.html">
      <meta name="docfx:tocrel" content="../../../../toc.html">
      
      <meta name="docfx:rel" content="../../../../">
      
      
      <meta name="docfx:docurl" content="https://github.com/bossbobofather-cpu/noname/blob/main/Library/PackageCache/com.unity.addressables@38fa2290d5f2/Documentation~/build-scripting-recompiling.md/#L1">
      <meta name="loc:inThisArticle" content="In this article">
      <meta name="loc:searchResultsCount" content="{count} results for &quot;{query}&quot;">
      <meta name="loc:searchNoResults" content="No results for &quot;{query}&quot;">
      <meta name="loc:tocFilter" content="Filter by title">
      <meta name="loc:nextArticle" content="Next">
      <meta name="loc:prevArticle" content="Previous">
      <meta name="loc:themeLight" content="Light">
      <meta name="loc:themeDark" content="Dark">
      <meta name="loc:themeAuto" content="Auto">
      <meta name="loc:changeTheme" content="Change theme">
      <meta name="loc:copy" content="Copy">
      <meta name="loc:downloadPdf" content="Download PDF">

      <script type="module" src="./../../../../public/docfx.min.js"></script>

      <script>
        const theme = localStorage.getItem('theme') || 'auto'
        document.documentElement.setAttribute('data-bs-theme', theme === 'auto' ? (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light') : theme)
      </script>

  </head>

  <body class="tex2jax_ignore" data-layout="" data-yaml-mime="">
    <header class="bg-body border-bottom">
      <nav id="autocollapse" class="navbar navbar-expand-md" role="navigation">
        <div class="container-xxl flex-nowrap">
          <a class="navbar-brand" href="../../../../index.html">
            <img id="logo" class="svg" src="../../../../logo.svg" alt="mysite">
            mysite
          </a>
          <button class="btn btn-lg d-md-none border-0" type="button" data-bs-toggle="collapse" data-bs-target="#navpanel" aria-controls="navpanel" aria-expanded="false" aria-label="Toggle navigation">
            <i class="bi bi-three-dots"></i>
          </button>
          <div class="collapse navbar-collapse" id="navpanel">
            <div id="navbar">
              <form class="search" role="search" id="search">
                <i class="bi bi-search"></i>
                <input class="form-control" id="search-query" type="search" disabled placeholder="Search" autocomplete="off" aria-label="Search">
              </form>
            </div>
          </div>
        </div>
      </nav>
    </header>

    <main class="container-xxl">

      <div class="content">
        <div class="actionbar">

          <nav id="breadcrumb"></nav>
        </div>

        <article data-uid="">
<h1 id="handle-domain-reloads">Handle domain reloads</h1>

<p>If your scripted build process changes settings that trigger a domain reload before making a build, use <a href="xref:um-command-line-arguments">Unity's command line arguments</a> rather than running a script in the Unity Editor. These types of settings include:</p>
<ul>
<li>Changing the <a href="xref:um-custom-scripting-symbols">scripting define symbols</a>.</li>
<li>Changing platform target or target group.</li>
</ul>
<p>Using methods such as setting scripting define symbols with <a href="https://docs.unity3d.com/ScriptReference/PlayerSettings.SetScriptingDefineSymbolsForGroup.html"><code>PlayerSettings.SetScriptingDefineSymbolsForGroup</code></a>, or switching the active build target with <a href="https://docs.unity3d.com/ScriptReference/EditorUserBuildSettings.SwitchActiveBuildTarget.html"><code>EditorUserBuildSettings.SwitchActiveBuildTarget</code></a>, triggers scripts to recompile and reload. The execution of the Unity Editor code continues with the currently loaded domain until the domain reloads and execution stops. Any <a href="https://docs.unity3d.com/Manual/PlatformDependentCompilation.html">platform dependent compilation</a> or custom defines isn't set until after the domain reloads. This can lead to unexpected issues where code relies on these defines to build correctly, and can be easily missed.</p>
<p>When you run a script that triggers a domain reload interactively in the Editor, such as using a menu command, your Editor script finishes executing before the domain reload happens. Therefore, if you immediately start an Addressables build, both your code and imported assets are still in their original state. You must wait for the domain reload to complete before you start the content build.</p>
<p>It's best practice to wait for the domain reload to finish when you run the build from the command line, because it can be difficult or impossible to carry out reliably in an interactive script.</p>
<p>The following example script defines two functions that can be invoked when running Unity on the command line. The <code>ChangeSettings</code> example sets the specified define symbols. The <code>BuildContentAndPlayer</code> function runs the Addressables build and the Player build.</p>
<pre><code class="lang-cs" name="sample">
#if UNITY_EDITOR
    using System;
    using UnityEditor;
    using UnityEditor.AddressableAssets;
    using UnityEditor.AddressableAssets.Build;
    using UnityEditor.AddressableAssets.Settings;
    using UnityEditor.Build.Reporting;
    using UnityEngine;

    internal class BatchBuild
    {
        public static string build_script
            = &quot;Assets/AddressableAssetsData/DataBuilders/BuildScriptPackedMode.asset&quot;;

        public static string profile_name = &quot;Default&quot;;

        public static void ChangeSettings()
        {
            string defines = &quot;&quot;;
            string[] args = Environment.GetCommandLineArgs();

            foreach (var arg in args)
                if (arg.StartsWith(&quot;-defines=&quot;, System.StringComparison.CurrentCulture))
                    defines = arg.Substring((&quot;-defines=&quot;.Length));

            var buildSettings = EditorUserBuildSettings.selectedBuildTargetGroup;
            PlayerSettings.SetScriptingDefineSymbolsForGroup(buildSettings, defines);
        }

        public static void BuildContentAndPlayer()
        {
            AddressableAssetSettings settings
                = AddressableAssetSettingsDefaultObject.Settings;

            settings.activeProfileId
                = settings.profileSettings.GetProfileId(profile_name);

            IDataBuilder builder
                = AssetDatabase.LoadAssetAtPath&lt;ScriptableObject&gt;(build_script) as IDataBuilder;

            settings.ActivePlayerDataBuilderIndex
                = settings.DataBuilders.IndexOf((ScriptableObject)builder);

            AddressableAssetSettings.BuildPlayerContent(out AddressablesPlayerBuildResult result);

            if (!string.IsNullOrEmpty(result.Error))
                throw new Exception(result.Error);

            BuildReport buildReport
                = BuildPipeline.BuildPlayer(EditorBuildSettings.scenes,
                    &quot;d:/build/winApp.exe&quot;, EditorUserBuildSettings.activeBuildTarget,
                    BuildOptions.None);

            if (buildReport.summary.result != BuildResult.Succeeded)
                throw new Exception(buildReport.summary.ToString());
        }
    }
#endif

</code></pre>
<p>To call these functions, use <a href="xref:um-command-line-arguments">Unity's command line arguments</a> in a terminal or command prompt or in a shell script:</p>
<pre><code>D:\Unity\2020.3.0f1\Editor\Unity.exe -quit -batchMode -projectPath . -executeMethod BatchBuild.ChangeSettings -defines=FOO;BAR -buildTarget Android
D:\Unity\2020.3.0f1\Editor\Unity.exe -quit -batchMode -projectPath . -executeMethod BatchBuild.BuildContentAndPlayer -buildTarget Android
</code></pre>
<div class="NOTE">
<h5>Note</h5>
<p>If you specify the platform target as a command line parameter, you can perform an Addressables build in the same command. However, if you wanted to change the platform in a script, you should do it in a separate command, such as the <code>ChangeSettings</code> function in this example.</p>
</div>
<h2 id="change-scripts-before-building">Change scripts before building</h2>
<p>To change platform, or modify Editor scripts in code and then continue with the defines set, a domain reload must be performed. In this case, the <code>-quit</code> argument should not be used or the Editor will exit immediately after execution of the invoked method.</p>
<p>When the domain reloads, <code>InitializeOnLoad</code> is invoked. The code below demonstrates how to set scripting define symbols and react to those in the Editor code, building Addressables after the domain reload completes. The same process can be done for switching platforms and <a href="https://docs.unity3d.com/Manual/PlatformDependentCompilation.html">platform dependent compilation</a>.</p>
<pre><code class="lang-c#">[InitializeOnLoad]
public class BuildWithScriptingDefinesExample
{
    static BuildWithScriptingDefinesExample()
    {
        bool toBuild = SessionState.GetBool(&quot;BuildAddressables&quot;, false);
        SessionState.EraseBool(&quot;BuildAddressables&quot;);
        if (toBuild)
        {
            Debug.Log(&quot;Domain reload complete, building Addressables as requested&quot;);
            BuildAddressablesAndRevertDefines();
        }
    }

    [MenuItem(&quot;Build/Addressables with script define&quot;)]
    public static void BuildTest()
    {
#if !MYDEFINEHERE
        Debug.Log(&quot;Setting up SessionState to inform an Addressables build is requested on next Domain Reload&quot;);
        SessionState.SetBool(&quot;BuildAddressables&quot;, true);
        string originalDefines = PlayerSettings.GetScriptingDefineSymbolsForGroup(EditorUserBuildSettings.selectedBuildTargetGroup);
        string newDefines = string.IsNullOrEmpty(originalDefines) ? &quot;MYDEFINEHERE&quot; : originalDefines + &quot;;MYDEFINEHERE&quot;;
        Debug.Log(&quot;Setting Scripting Defines, this will then start compiling and begin a domain reload of the Editor Scripts.&quot;);
        PlayerSettings.SetScriptingDefineSymbolsForGroup(EditorUserBuildSettings.selectedBuildTargetGroup, newDefines);
#endif
    }

    static void BuildAddressablesAndRevertDefines()
    {
#if MYDEFINEHERE
        Debug.Log(&quot;Correct scripting defines set for desired build&quot;);
        AddressableAssetSettings.BuildPlayerContent();
        string originalDefines = PlayerSettings.GetScriptingDefineSymbolsForGroup(EditorUserBuildSettings.selectedBuildTargetGroup);
        if (originalDefines.Contains(&quot;;MYDEFINEHERE&quot;))
            originalDefines = originalDefines.Replace(&quot;;MYDEFINEHERE&quot;, &quot;&quot;);
        else
            originalDefines = originalDefines.Replace(&quot;MYDEFINEHERE&quot;, &quot;&quot;);
        PlayerSettings.SetScriptingDefineSymbolsForGroup(EditorUserBuildSettings.selectedBuildTargetGroup, originalDefines);
        AssetDatabase.SaveAssets();
#endif
        EditorApplication.Exit(0);
    }
}
</code></pre>
<h2 id="additional-resources">Additional resources</h2>
<ul>
<li><a href="build-scripting-custom.html">Create a custom build script</a></li>
<li><a href="build-scripting-start-build.html">Start a build from a script</a></li>
<li><a href="xref:um-command-line-arguments">Command line arguments reference</a></li>
</ul>

</article>

        <div class="contribution d-print-none">
          <a href="https://github.com/bossbobofather-cpu/noname/blob/main/Library/PackageCache/com.unity.addressables@38fa2290d5f2/Documentation~/build-scripting-recompiling.md/#L1" class="edit-link">Edit this page</a>
        </div>

        <div class="next-article d-print-none border-top" id="nextArticle"></div>

      </div>

      <div class="affix">
        <nav id="affix"></nav>
      </div>
    </main>

    <div class="container-xxl search-results" id="search-results"></div>

    <footer class="border-top text-secondary">
      <div class="container-xxl">
        <div class="flex-fill">
          <span>Made with <a href="https://dotnet.github.io/docfx">docfx</a></span>
        </div>
      </div>
    </footer>
  </body>
</html>
